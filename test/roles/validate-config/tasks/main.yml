- name: Make temporary workspace
  tempfile:
    path: "{{ lookup('env', 'TMPDIR')|default(omit, boolean=True) }}"
    state: directory
    suffix: acvars
  register: actmpdir 

- name: Show the tmp path
  debug: msg="Temporary directory is {{ actmpdir.path }}"

- name: Copy files to workspace
  copy:
    src: "{{ role_path }}/files/{{ item }}"
    dest: "{{ actmpdir.path }}"   
  with_items:
  - container.yml
  - vars.yml
  - vars.txt

- name: Create roles directory
  file:
    path: "{{ actmpdir.path }}/roles/"
    state: directory

- name: Copy role 
  copy:
    src: "{{ role_path }}/files/test-variables"
    dest: "{{ actmpdir.path }}/roles"

- name: Test container/config.py 
  shell: pytest {{ playbook_dir }}/tests/validate_config.py >>{{ playbook_dir }}/task.output 2>&1
  args:
    chdir: "{{ actmpdir.path }}" 
  environment:
    PROJECT_PATH: "{{ actmpdir.path | quote }}"
  register: output
  ignore_errors: yes

- include: includes/show-output.yml output_file=./task.output registered_output="{{ output }}"    

- name: Run 'ansible-container build'
  shell: ansible-container --debug --project-name test-config build >>{{ playbook_dir }}/task.output 2>&1
  args:
    chdir: "{{ actmpdir.path }}"
  register: output
  ignore_errors: yes

- name: Save build output
  command: cat ./task.output 
  register: build_output

- include: includes/show-output.yml output_file=./task.output registered_output="{{ output }}"    

# Expected output:
# Playbook generated: [{'hosts': u'web', 'roles': [ordereddict([('role', 'test-variables')])], 'vars': {u'debug': 0, u'web_image': u'centos:7', u'foo': u'bar', u'project_path': u'/foo', u'web_ports': [u'8080:80']}}] [container.utils]
- name: Test build output for container.yml defaults
  assert:
    that:
      - "build_output.stdout is search(\"'web_image': u'centos:7'\")"
      - "'8080:80' in build_output.stdout"
      - "build_output.stdout is search(\"'debug': 0\")"
      - "build_output.stdout is search(\"'foo': u'bar'\")"
      - "build_output.stdout is search(\"'project_path': u'/foo'\")"
